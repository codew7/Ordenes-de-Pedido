<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ingreso de Órdenes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, push, set, get, child } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD1mkIC2sQwvpMm-x-R_ReL-3mvOFNZAcA",
      authDomain: "ordenes-de-pedido-e4248.firebaseapp.com",
      databaseURL: "https://ordenes-de-pedido-e4248-default-rtdb.firebaseio.com",
      projectId: "ordenes-de-pedido-e4248",
      storageBucket: "ordenes-de-pedido-e4248.firebasestorage.app",
      messagingSenderId: "244600094131",
      appId: "1:244600094131:web:f44687583d9395f15c9fc6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase();

    window.onload = async () => {
      // Cargar artículos desde Google Sheets
      const API_KEY = 'AIzaSyDwiZWDc66tv4usDIA-IreiJMLFuk0236Q';
      const SHEET_ID = '1cD50d0-oSTogEe9tYo9ABUSP1ONCy3SAV92zsYYIG84';
      const RANGE = 'Lista!C2:G';

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();

      const productos = data.values || [];
      productos.forEach(prod => {
        const option = document.createElement("option");
        option.value = prod[1];
        option.dataset.codigo = prod[0];
        option.dataset.valor = prod[2];
        option.dataset.costo = prod[4];
        document.getElementById("articulo").appendChild(option);
      });

      document.getElementById("producto").addEventListener("input", (e) => {
        const selected = [...document.getElementById("articulo").options].find(opt => opt.value === e.target.value);
        if (selected) {
          document.getElementById("codigo").value = selected.dataset.codigo;
          document.getElementById("valor").value = selected.dataset.valor;
          document.getElementById("costo").value = selected.dataset.costo;
          calcularTotal();
        }
      });

      ["cantidad", "valor", "costo"].forEach(id => {
        document.getElementById(id).addEventListener("input", calcularTotal);
      });

      document.getElementById("registrar").addEventListener("click", async () => {
        const pedidosRef = ref(db, "Ordenes");
        const ordenesSnap = await get(pedidosRef);
        let nextId = 8000;

        if (ordenesSnap.exists()) {
          const keys = Object.keys(ordenesSnap.val());
          const last = Math.max(...keys.map(k => parseInt(ordenesSnap.val()[k].orden_id || 8000)));
          nextId = last + 1;
        }

        const orden = {
          orden_id: nextId,
          timestamp: new Date().toISOString(),
          cliente: {
            tipo: document.getElementById("tipo").value,
            nombre: document.getElementById("nombre").value,
            telefono: document.getElementById("telefono").value,
            direccion: document.getElementById("direccion").value,
          },
          pedido: {
            codigo: document.getElementById("codigo").value,
            articulo: document.getElementById("producto").value,
            cantidad: parseInt(document.getElementById("cantidad").value),
            valor_u: parseFloat(document.getElementById("valor").value),
            costo_u: parseFloat(document.getElementById("costo").value),
            total: parseFloat(document.getElementById("total").value)
          },
          pagos: {
            subtotal: parseFloat(document.getElementById("total").value),
            medio_pago: document.getElementById("medio_pago").value,
            costo_envio: parseFloat(document.getElementById("envio").value || 0),
            total_costo: parseFloat(document.getElementById("costo").value),
            total_ganancia: parseFloat(document.getElementById("ganancia").value),
            recargo: parseFloat(document.getElementById("recargo").value),
            descuento: parseFloat(document.getElementById("descuento").value),
            total_final: parseFloat(document.getElementById("final").value),
            vendedor: document.getElementById("vendedor").value,
            nota: document.getElementById("nota").value,
          }
        };

        await push(pedidosRef, orden);
        alert("Orden registrada con ID #" + nextId);
        location.reload();
      });

      // Cálculo de totales
      ["medio_pago", "envio", "descuento"].forEach(id => {
        document.getElementById(id).addEventListener("input", calcularTotalesFinales);
      });
    }

    function calcularTotal() {
      const cantidad = parseFloat(document.getElementById("cantidad").value || 0);
      const valor = parseFloat(document.getElementById("valor").value || 0);
      const costo = parseFloat(document.getElementById("costo").value || 0);
      const total = cantidad * valor;
      const totalCosto = cantidad * costo;
      document.getElementById("total").value = total.toFixed(2);
      document.getElementById("ganancia").value = (total - totalCosto).toFixed(2);
      calcularTotalesFinales();
    }

    function calcularTotalesFinales() {
      const subtotal = parseFloat(document.getElementById("total").value || 0);
      const medioPago = document.getElementById("medio_pago").value;
      const envio = parseFloat(document.getElementById("envio").value || 0);
      const descuento = parseFloat(document.getElementById("descuento").value || 0);
      const recargo = medioPago === "MercadoPago" ? subtotal * 0.06 : 0;
      document.getElementById("recargo").value = recargo.toFixed(2);
      const totalFinal = subtotal + envio + recargo - descuento;
      document.getElementById("final").value = totalFinal.toFixed(2);
    }
  </script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    h2 {
      margin-bottom: 10px;
    }
    label {
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 6px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    .full { grid-column: span 2; }
    button {
      background: #007acc;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #005fa3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Formulario de Pedido</h2>

    <div class="grid">
      <div>
        <label>Tipo Cliente</label>
        <select id="tipo">
          <option>Consumidor Final</option>
          <option>Mayorista</option>
          <option>Envios</option>
        </select>
      </div>
      <div>
        <label>Nombre</label>
        <input id="nombre">
      </div>
      <div>
        <label>Teléfono</label>
        <input id="telefono">
      </div>
      <div>
        <label>Dirección</label>
        <input id="direccion">
      </div>

      <div>
        <label>Artículo</label>
        <input list="articulo" id="producto">
        <datalist id="articulo"></datalist>
      </div>
      <div>
        <label>Código</label>
        <input id="codigo" readonly>
      </div>
      <div>
        <label>Cantidad</label>
        <input type="number" id="cantidad">
      </div>
      <div>
        <label>Valor u.</label>
        <input type="number" id="valor">
      </div>
      <div>
        <label>Costo u.</label>
        <input type="number" id="costo">
      </div>
      <div>
        <label>Total</label>
        <input id="total" readonly>
      </div>

      <div>
        <label>Subtotal</label>
        <input id="subtotal" readonly>
      </div>
      <div>
        <label>Medio de Pago</label>
        <select id="medio_pago">
          <option>Efectivo</option>
          <option>MercadoPago</option>
          <option>Transferencia</option>
          <option>ML</option>
        </select>
      </div>
      <div>
        <label>Costo Envío</label>
        <input type="number" id="envio" value="0">
      </div>
      <div>
        <label>Total Costo</label>
        <input id="costo_total" readonly>
      </div>
      <div>
        <label>Total Ganancia</label>
        <input id="ganancia" readonly>
      </div>
      <div>
        <label>Recargo</label>
        <input id="recargo" readonly>
      </div>
      <div>
        <label>Descuento</label>
        <input type="number" id="descuento" value="0">
      </div>
      <div>
        <label>Total Final</label>
        <input id="final" readonly>
      </div>

      <div>
        <label>Vendedor</label>
        <input id="vendedor">
      </div>
      <div class="full">
        <label>Nota</label>
        <textarea id="nota" rows="3"></textarea>
      </div>
    </div>

    <button id="registrar">Registrar Pedido</button>
  </div>
</body>
</html>
